<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Edge Impulse Object Detection Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header img {
            height: 60px;
            margin-bottom: 15px;
        }
        .settings-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .video-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .video-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            min-height: 450px;
        }
        .video-frame {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: #f8f9fa;
        }
        .stats {
            margin-top: 10px;
            font-size: 14px;
            color: #6c757d;
        }
        .stats-value {
            font-size: 18px;
            font-weight: bold;
            color: #212529;
        }
        .btn-primary {
            background-color: #4e73df;
            border-color: #4e73df;
        }
        .form-select, .form-control {
            border-radius: 4px;
            border: 1px solid #d1d3e2;
        }
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: none;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }
        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status-reconnecting {
            background-color: #fff3cd;
            color: #856404;
        }
        .asset-preview {
            max-width: 100px;
            max-height: 60px;
            object-fit: contain;
            margin-left: 10px;
            vertical-align: middle;
        }
        @media (max-width: 768px) {
            .video-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="header">
            <img src="assets/EI_logo_stacked.png" alt="Edge Impulse">
            <h2>Object Detection Demo</h2>
            <p class="text-muted">Using Edge Impulse and Arduino App Lab</p>
        </div>

        <div class="settings-card">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label class="form-label">Input Source</label>
                    <select id="sourceSelect" class="form-select">
                        <option value="image">Image</option>
                        <option value="video">Video</option>
                        <option value="rtsp">RTSP Stream</option>
                        <option value="camera">Connected Camera</option>
                    </select>
                </div>
                <div class="col-md-3" id="imageSelectGroup">
                    <label class="form-label">Image</label>
                    <select id="imageSelect" class="form-select">
                        <option value="" disabled selected>Loading images...</option>
                    </select>
                </div>
                <div class="col-md-3" id="videoSelectGroup" style="display: none;">
                    <label class="form-label">Video</label>
                    <select id="videoSelect" class="form-select">
                        <option value="" disabled selected>Loading videos...</option>
                    </select>
                </div>
                <div class="col-md-3" id="cameraSelectGroup" style="display: none;">
                    <label class="form-label">Camera</label>
                    <select id="cameraSelect" class="form-select">
                        <option value="" disabled selected>Loading cameras...</option>
                    </select>
                </div>
                <div class="col-md-3" id="rtspGroup" style="display: none;">
                    <label class="form-label">RTSP URL</label>
                    <input type="text" id="rtspUrl" class="form-control" placeholder="rtsp://192.168.1.113:1935/stream">
                    <div id="rtspError" class="error-message">Invalid RTSP URL format</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Model</label>
                    <select id="modelSelect" class="form-select">
                        <option value="" disabled selected>Loading models...</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button id="applyBtn" class="btn btn-primary w-100">Apply</button>
                </div>
            </div>
        </div>

        <div class="video-container">
            <div class="video-panel">
                <h5>Original</h5>
                <div id="originalConnectionStatus" class="connection-status" style="display: none;"></div>
                <div id="originalLoader" class="loader">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading original...</p>
                </div>
                <img id="originalFeed" class="video-frame" src="{{ url_for('video_feed') }}">
                <div id="originalError" class="error-message">Failed to load original feed</div>
            </div>
            <div class="video-panel">
                <h5>Detection Results</h5>
                <div id="detectionConnectionStatus" class="connection-status" style="display: none;"></div>
                <div id="detectionLoader" class="loader">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing detection...</p>
                </div>
                <img id="detectionFeed" class="video-frame" src="{{ url_for('inference_feed') }}">
                <div id="detectionError" class="error-message">Failed to load detection feed</div>
                <div class="stats">
                    <div>Inference: <span id="inferenceSpeed" class="stats-value">0</span> ms</div>
                    <div>Objects: <span id="objectCount" class="stats-value">0</span></div>
                </div>
            </div>
        </div>

        <div class="settings-card">
            <h5 class="mb-3">Upload to Edge Impulse</h5>
            <div class="row align-items-end">
                <div class="col-md-5">
                    <label class="form-label">Project API Key</label>
                    <input type="password" id="eiApiKey" class="form-control" placeholder="Enter API Key">
                    <div id="apiKeySavedMsg" class="text-success" style="display:none;font-size:13px;">Saved!</div>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Category</label>
                    <select id="eiCategory" class="form-select">
                        <option value="training">Training</option>
                        <option value="testing">Testing</option>
                        <option value="split">Split</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Labels</label>
                    <select id="eiLabelMode" class="form-select">
                        <option value="none" selected>No Labels</option>
                        <option value="bboxes">Bounding Boxes</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="eiUploadBtn" class="btn btn-success w-100">Upload</button>
                    <div id="eiUploadMsg" style="font-size:13px;display:none;"></div>
                </div>
            </div>

        </div>

        <div class="settings-card">
            <h5 class="mb-3">Deploy Model from Edge Impulse</h5>
            <div class="row align-items-end">
                <div class="col-md-5">
                    <label class="form-label">Project API Key</label>
                    <input type="password" id="eiDeployApiKey" class="form-control" placeholder="Enter API Key">
                    <div id="deployApiKeySavedMsg" class="text-success" style="display:none;font-size:13px;">Saved!</div>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Impulse ID</label>
                    <input type="text" id="eiDeployImpulseId" class="form-control" inputmode="numeric" placeholder="e.g. 1">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Deployment target</label>
                    <select id="eiDeployTarget" class="form-select">
                        <option value="runner-linux-aarch64" selected>runner-linux-aarch64 (default)</option>
                        <option value="runner-linux-armv7">runner-linux-armv7</option>
                        <option value="runner-linux-x86">runner-linux-x86</option>
                        <option value="runner-mac-arm64">runner-mac-arm64</option>
                        <option value="runner-mac-x86_64">runner-mac-x86_64</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Quantization</label>
                    <select id="eiDeployQuant" class="form-select">
                        <option value="float32" selected>float32 (default)</option>
                        <option value="int8">int8</option>
                    </select>
                </div>
                <div class="col-md-2" style="padding-top: 10px;">
                    <div class="d-flex flex-row align-items-end gap-2">
                        <button id="eiDeployDownloadBtn" class="btn btn-primary flex-fill">Download</button>
                        <button id="eiDeployRebuildBtn" class="btn btn-outline-secondary" style="font-size:0.95em; min-width: 90px;">Rebuild</button>
                    </div>
                </div>
            </div>
            <div class="mt-2" style="font-size:13px;">
                <div id="eiDeployMsg" style="display:none;"></div>
                <pre id="eiDeployLogs" class="mt-2" style="display:none; max-height: 180px; overflow:auto; background:#f8f9fa; border:1px solid #dee2e6; padding:10px;"></pre>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const dom = {
            sourceSelect: document.getElementById('sourceSelect'),
            imageSelect: document.getElementById('imageSelect'),
            videoSelect: document.getElementById('videoSelect'),
            cameraSelect: document.getElementById('cameraSelect'),
            rtspUrl: document.getElementById('rtspUrl'),
            rtspError: document.getElementById('rtspError'),
            applyBtn: document.getElementById('applyBtn'),
            modelSelect: document.getElementById('modelSelect'),
            originalLoader: document.getElementById('originalLoader'),
            detectionLoader: document.getElementById('detectionLoader'),
            originalFeed: document.getElementById('originalFeed'),
            detectionFeed: document.getElementById('detectionFeed'),
            originalError: document.getElementById('originalError'),
            detectionError: document.getElementById('detectionError'),
            originalConnectionStatus: document.getElementById('originalConnectionStatus'),
            detectionConnectionStatus: document.getElementById('detectionConnectionStatus'),
            imageSelectGroup: document.getElementById('imageSelectGroup'),
            videoSelectGroup: document.getElementById('videoSelectGroup'),
            cameraSelectGroup: document.getElementById('cameraSelectGroup'),
            rtspGroup: document.getElementById('rtspGroup'),
            inferenceSpeed: document.getElementById('inferenceSpeed'),
            objectCount: document.getElementById('objectCount'),
            eiApiKey: document.getElementById('eiApiKey'),
            apiKeySavedMsg: document.getElementById('apiKeySavedMsg'),
            eiCategory: document.getElementById('eiCategory'),
            eiLabelMode: document.getElementById('eiLabelMode'),
            eiUploadBtn: document.getElementById('eiUploadBtn'),
            eiUploadMsg: document.getElementById('eiUploadMsg'),

            eiDeployApiKey: document.getElementById('eiDeployApiKey'),
            deployApiKeySavedMsg: document.getElementById('deployApiKeySavedMsg'),
            eiDeployImpulseId: document.getElementById('eiDeployImpulseId'),
            eiDeployTarget: document.getElementById('eiDeployTarget'),
            eiDeployQuant: document.getElementById('eiDeployQuant'),
            eiDeployDownloadBtn: document.getElementById('eiDeployDownloadBtn'),
            eiDeployRebuildBtn: document.getElementById('eiDeployRebuildBtn'),
            eiDeployMsg: document.getElementById('eiDeployMsg'),
            eiDeployLogs: document.getElementById('eiDeployLogs'),
        };

        // --- API Key Storage ---
        function saveApiKeyToStorage(key) {
            localStorage.setItem('eiApiKey', key);
        }
        function getApiKeyFromStorage() {
            return localStorage.getItem('eiApiKey') || '';
        }
        function showApiKeySaved() {
            dom.apiKeySavedMsg.style.display = 'inline';
            setTimeout(() => { dom.apiKeySavedMsg.style.display = 'none'; }, 1200);
        }

        // --- Deployment API Key Storage ---
        function saveDeployApiKeyToStorage(key) {
            localStorage.setItem('eiDeployApiKey', key);
        }
        function getDeployApiKeyFromStorage() {
            return localStorage.getItem('eiDeployApiKey') || '';
        }
        function showDeployApiKeySaved() {
            dom.deployApiKeySavedMsg.style.display = 'inline';
            setTimeout(() => { dom.deployApiKeySavedMsg.style.display = 'none'; }, 1200);
        }

        function saveDeployImpulseIdToStorage(value) {
            localStorage.setItem('eiDeployImpulseId', String(value ?? '').trim());
        }
        function getDeployImpulseIdFromStorage() {
            return localStorage.getItem('eiDeployImpulseId') || '';
        }

        function saveDeployTargetToStorage(value) {
            localStorage.setItem('eiDeployTarget', String(value ?? '').trim());
        }
        function getDeployTargetFromStorage() {
            return localStorage.getItem('eiDeployTarget') || '';
        }

        function saveDeployQuantToStorage(value) {
            localStorage.setItem('eiDeployQuant', String(value ?? '').trim());
        }
        function getDeployQuantFromStorage() {
            return localStorage.getItem('eiDeployQuant') || '';
        }

        // --- Upload Options Storage ---
        function saveEiCategoryToStorage(value) {
            localStorage.setItem('eiUploadCategory', value);
        }
        function getEiCategoryFromStorage() {
            return localStorage.getItem('eiUploadCategory') || '';
        }
        function saveEiLabelModeToStorage(value) {
            localStorage.setItem('eiUploadLabelMode', value);
        }
        function getEiLabelModeFromStorage() {
            return localStorage.getItem('eiUploadLabelMode') || '';
        }

        // --- Edge Impulse Upload ---
        function showEiUploadMsg(msg, success = true) {
            dom.eiUploadMsg.textContent = msg;
            dom.eiUploadMsg.style.display = 'block';
            dom.eiUploadMsg.style.color = success ? '#198754' : '#dc3545';
            setTimeout(() => { dom.eiUploadMsg.style.display = 'none'; }, 3000);
        }

        // --- Edge Impulse Deploy ---
        let eiDeployPollController = null;
        let eiDeployPollAbortController = null;
        let activeDeployRunId = 0;
        let lastDeployLogs = [];
        let cachedProjectId = null;
        let downloadWaitTimer = null;
        const EI_DEPLOY_ENGINE = 'tflite';
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        async function safeJson(resp) {
            try {
                return await resp.json();
            } catch {
                return {};
            }
        }

        function showEiDeployMsg(msg, success = true, keep = false) {
            dom.eiDeployMsg.textContent = msg;
            dom.eiDeployMsg.style.display = 'block';
            dom.eiDeployMsg.style.color = success ? '#198754' : '#dc3545';
            if (!keep) {
                setTimeout(() => { dom.eiDeployMsg.style.display = 'none'; }, 4000);
            }
        }

        // --- Logs streaming ---
        function setEiDeployLogs(lines) {
            // Show only new lines appended, but keep all lines in the box
            if (!Array.isArray(lines)) lines = [];
            // If logs are truncated, just show all
            if (lines.length < lastDeployLogs.length) {
                lastDeployLogs = [];
            }
            // Find the first difference
            let firstNew = lines.length;
            for (let i = 0; i < lines.length; ++i) {
                if (lastDeployLogs[i] !== lines[i]) {
                    firstNew = i;
                    break;
                }
            }
            // Append only new lines
            const newLines = lines.slice(firstNew);
            if (firstNew === 0) {
                dom.eiDeployLogs.textContent = lines.join('\n');
            } else if (newLines.length > 0) {
                dom.eiDeployLogs.textContent += '\n' + newLines.join('\n');
            }
            // Always keep logs visible after a run until next action
            dom.eiDeployLogs.style.display = lines.length ? 'block' : 'none';
            lastDeployLogs = lines.slice();
        }

        function syncProjectIdFromResponse(data) {
            if (!data) return;
            const pid = data.projectId ?? data.projectID;
            if (pid === undefined || pid === null) return;
            const num = Number(pid);
            if (Number.isFinite(num) && num > 0) {
                cachedProjectId = num;
            }
        }

        function withProjectId(payload) {
            if (cachedProjectId) payload.projectId = cachedProjectId;
            return payload;
        }

        function beginDownloadWaitHint() {
            clearDownloadWaitHint();
            downloadWaitTimer = setTimeout(() => {
                showEiDeployMsg('Still downloading from Edge Impulse ...', true, true);
            }, 8000);
        }

        function clearDownloadWaitHint() {
            if (downloadWaitTimer) {
                clearTimeout(downloadWaitTimer);
                downloadWaitTimer = null;
            }
        }

        function cancelActiveDeployPoll() {
            if (eiDeployPollAbortController) {
                eiDeployPollAbortController.abort();
                eiDeployPollAbortController = null;
            }
            if (eiDeployPollController) {
                eiDeployPollController.aborted = true;
                eiDeployPollController = null;
            }
        }

        function isCurrentDeployRun(runId) {
            return runId === activeDeployRunId;
        }

        function setDeployButtonsDisabled(disabled, runId) {
            if (!isCurrentDeployRun(runId)) return;
            dom.eiDeployDownloadBtn.disabled = disabled;
            dom.eiDeployRebuildBtn.disabled = disabled;
        }

        async function pollDeploymentUntilFinished(pollPayload, options = {}) {
            const controller = { aborted: false };
            eiDeployPollController = controller;

            const abortController = new AbortController();
            eiDeployPollAbortController = abortController;

            const initialDelay = options.initialDelay ?? 400;
            const maxDelay = options.maxDelay ?? 1600;
            const backoff = options.backoff ?? 1.3;
            let delay = initialDelay;

            try {
                while (!controller.aborted) {
                    let stResp;
                    try {
                        stResp = await fetch('/ei/deployment/status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(withProjectId(pollPayload)),
                            signal: abortController.signal,
                        });
                    } catch (err) {
                        if (err?.name === 'AbortError') {
                            return { aborted: true };
                        }
                        return { error: err?.message || 'Network error while polling status' };
                    }

                    const stData = await safeJson(stResp);
                    syncProjectIdFromResponse(stData);

                    if (!stResp.ok || stData.status !== 'success') {
                        return { error: stData?.message || stResp.statusText || 'Status error' };
                    }

                    setEiDeployLogs(stData.logsAll || stData.logsTail || []);

                    if (stData.finished) {
                        return { ok: stData.success === true };
                    }

                    await sleep(delay);
                    delay = Math.min(maxDelay, Math.round(delay * backoff));
                }

                return { aborted: true };
            } finally {
                if (eiDeployPollAbortController === abortController) {
                    eiDeployPollAbortController = null;
                }
                if (eiDeployPollController === controller) {
                    eiDeployPollController = null;
                }
            }
        }

        async function deployDownloadOrBuild({forceRebuild = false} = {}) {
            cancelActiveDeployPoll();
            const runId = ++activeDeployRunId;
            clearDownloadWaitHint();
            // Clear logs only on new user action (not on build/download finish)
            setEiDeployLogs([]);

            // Persist current deploy settings immediately (even if user never blurred/changed focus)
            if (dom.eiDeployImpulseId) saveDeployImpulseIdToStorage(dom.eiDeployImpulseId.value);
            if (dom.eiDeployTarget) saveDeployTargetToStorage(dom.eiDeployTarget.value);
            if (dom.eiDeployQuant) saveDeployQuantToStorage(dom.eiDeployQuant.value);

            const deployApiKey = (dom.eiDeployApiKey.value || '').trim() || getDeployApiKeyFromStorage();
            if (!deployApiKey) {
                showEiDeployMsg('Deployment API key required', false);
                setDeployButtonsDisabled(false, runId);
                return;
            }
            if ((dom.eiDeployApiKey.value || '').trim() && dom.eiDeployApiKey.value !== getDeployApiKeyFromStorage()) {
                saveDeployApiKeyToStorage(dom.eiDeployApiKey.value);
            }

            const impulseIdRaw = (dom.eiDeployImpulseId?.value || '').trim() || getDeployImpulseIdFromStorage();
            let impulseId = null;
            if (impulseIdRaw) {
                const parsed = parseInt(impulseIdRaw, 10);
                if (!Number.isFinite(parsed) || parsed <= 0) {
                    showEiDeployMsg('Impulse ID must be a positive integer', false);
                    setDeployButtonsDisabled(false, runId);
                    return;
                }
                impulseId = parsed;
                // Keep it persisted
                saveDeployImpulseIdToStorage(String(parsed));
            }

            const deploymentType = dom.eiDeployTarget.value;
            const quantization = dom.eiDeployQuant?.value || 'float32';
            const enginePref = EI_DEPLOY_ENGINE;
            if (!deploymentType) {
                showEiDeployMsg('Select a deployment target', false);
                setDeployButtonsDisabled(false, runId);
                return;
            }

            setDeployButtonsDisabled(true, runId);
            if (!forceRebuild) {
                // Try to download existing deployment first
                showEiDeployMsg('Checking for existing deployment...', true, true);
                try {
                    beginDownloadWaitHint();
                    const dlResp = await fetch('/ei/deployment/download', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(withProjectId({
                            deployApiKey,
                            deploymentType,
                            impulseId,
                            quantization,
                            engine: enginePref,
                        }))
                    });
                    const dlData = await safeJson(dlResp);
                    syncProjectIdFromResponse(dlData);
                    if (dlResp.ok && dlData.status === 'success') {
                        const saved = (dlData.savedModels || []).join(', ');
                        showEiDeployMsg('Downloaded: ' + (saved || 'model'), true, true);
                        loadModels();
                        setDeployButtonsDisabled(false, runId);
                        return;
                    }
                    // If not found, fall through to build
                    showEiDeployMsg('No existing deployment found, building...', true, true);
                } catch (e) {
                    // Network or other error, fall through to build
                    showEiDeployMsg('Could not reach deployment info, will build a new artifact...', false, true);
                } finally {
                    clearDownloadWaitHint();
                }
            } else {
                showEiDeployMsg('Forcing rebuild...', true, true);
            }

            // Start build
            try {
                const startResp = await fetch('/ei/deployment/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(withProjectId({
                        deployApiKey,
                        deploymentType,
                        quantization,
                        impulseId,
                    }))
                });
                const startData = await safeJson(startResp);
                syncProjectIdFromResponse(startData);
                if (!startResp.ok || startData.status !== 'success') {
                    showEiDeployMsg('Failed to start build: ' + (startData.message || startResp.statusText), false);
                    setDeployButtonsDisabled(false, runId);
                    return;
                }

                const jobId = startData.jobId;
                const deploymentVersion = startData.deploymentVersion;
                const buildEngine = startData.engine || enginePref;
                showEiDeployMsg(`Build started (job ${jobId}, engine ${buildEngine}, ${quantization}). Waiting for completion...`, true, true);

                const handleBuildCompletion = async (wasSuccessful) => {
                    if (!isCurrentDeployRun(runId)) return;
                    if (!wasSuccessful) {
                        showEiDeployMsg('Build failed. Check logs above.', false, true);
                        setDeployButtonsDisabled(false, runId);
                        return;
                    }

                    showEiDeployMsg('Build finished. Downloading artifact...', true, true);
                    try {
                        beginDownloadWaitHint();
                        const dlResp = await fetch('/ei/deployment/download', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(withProjectId({
                                deployApiKey,
                                deploymentVersion,
                                deploymentType,
                                impulseId,
                                quantization,
                                engine: buildEngine,
                            }))
                        });
                        const dlData = await safeJson(dlResp);
                        syncProjectIdFromResponse(dlData);
                        if (!dlResp.ok || dlData.status !== 'success') {
                            showEiDeployMsg('Download failed: ' + (dlData.message || dlResp.statusText), false, true);
                        } else {
                            const saved = (dlData.savedModels || []).join(', ');
                            showEiDeployMsg('Downloaded: ' + (saved || 'model'), true, true);
                            loadModels();
                        }
                    } catch (e) {
                        showEiDeployMsg('Download error', false, true);
                    } finally {
                        clearDownloadWaitHint();
                        setDeployButtonsDisabled(false, runId);
                    }
                };

                const pollResult = await pollDeploymentUntilFinished({ deployApiKey, jobId });
                if (!isCurrentDeployRun(runId)) return;
                if (pollResult?.error) {
                    showEiDeployMsg('Status error: ' + pollResult.error, false, true);
                    setDeployButtonsDisabled(false, runId);
                    return;
                }
                if (pollResult?.aborted) {
                    setDeployButtonsDisabled(false, runId);
                    return;
                }

                await handleBuildCompletion(pollResult?.ok === true);
            } catch (e) {
                showEiDeployMsg('Error starting build', false);
                setDeployButtonsDisabled(false, runId);
            }
        }

        async function uploadCurrentOriginalFrame() {
            const apiKey = (dom.eiApiKey.value || '').trim() || getApiKeyFromStorage();
            const category = dom.eiCategory.value;
            const includeLabels = (dom.eiLabelMode && dom.eiLabelMode.value === 'bboxes');
            if (!apiKey) {
                showEiUploadMsg('API key required', false);
                return;
            }

            // Ensure storage is updated even if the input hasn't lost focus yet
            if ((dom.eiApiKey.value || '').trim() && dom.eiApiKey.value !== getApiKeyFromStorage()) {
                saveApiKeyToStorage(dom.eiApiKey.value);
            }

            // Persist category/label mode even if user clicks immediately
            if (dom.eiCategory) saveEiCategoryToStorage(dom.eiCategory.value);
            if (dom.eiLabelMode) saveEiLabelModeToStorage(dom.eiLabelMode.value);

            dom.eiUploadBtn.disabled = true;
            showEiUploadMsg('Uploading...', true);
            try {
                const resp = await fetch('/upload_edge_impulse', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apiKey, category, includeLabels })
                });
                const data = await resp.json();
                if (resp.ok && data.status === 'success') {
                    showEiUploadMsg('Upload successful!', true);
                } else {
                    showEiUploadMsg('Upload failed: ' + (data.message || resp.statusText || 'Unknown error'), false);
                }
            } catch (e) {
                showEiUploadMsg('Upload error', false);
            } finally {
                dom.eiUploadBtn.disabled = false;
            }
        }

        // --- Utility Functions ---
        function setSelectOptions(select, options, defaultText) {
            select.innerHTML = '';
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = defaultText;
            defaultOption.disabled = true;
            defaultOption.selected = true;
            select.appendChild(defaultOption);
            options.forEach(opt => select.appendChild(opt));
        }

        function showLoader(loader, show = true) {
            loader.style.display = show ? 'block' : 'none';
        }
        function showError(error, show = true) {
            error.style.display = show ? 'block' : 'none';
        }
        function showFeed(feed, show = true) {
            feed.style.display = show ? 'block' : 'none';
        }

        // --- Asset Loading ---
        function loadAssets(type, select) {
            setSelectOptions(select, [], `Loading ${type}...`);
            const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 3000));
            const fetchPromise = fetch(`/get_assets?type=${type}`)
                .then(r => r.ok ? r.json() : Promise.reject('Network error'));
            Promise.race([fetchPromise, timeoutPromise])
                .then(assets => {
                    if (assets && assets.length > 0) {
                        const opts = assets.sort().map(asset => {
                            const o = document.createElement('option');
                            o.value = asset;
                            o.textContent = asset;
                            return o;
                        });
                        setSelectOptions(select, opts, `Select a ${type}...`);
                    } else {
                        setSelectOptions(select, [Object.assign(document.createElement('option'), {
                            value: '', textContent: `No ${type} found`, disabled: true
                        })], `Select a ${type}...`);
                    }
                })
                .catch(() => {
                    setSelectOptions(select, [Object.assign(document.createElement('option'), {
                        value: '', textContent: `Error loading ${type}`, disabled: true
                    })], `Select a ${type}...`);
                });
        }

        function loadCameras() {
            fetch('/get_cameras')
                .then(r => r.json())
                .then(cameras => {
                    if (cameras && cameras.length > 0) {
                        const opts = cameras.map(cam => {
                            const o = document.createElement('option');
                            o.value = cam;
                            o.textContent = `Camera ${cam}`;
                            return o;
                        });
                        setSelectOptions(dom.cameraSelect, opts, 'Select a camera...');
                    } else {
                        setSelectOptions(dom.cameraSelect, [Object.assign(document.createElement('option'), {
                            value: '0', textContent: 'No cameras found', disabled: true
                        })], 'Select a camera...');
                    }
                })
                .catch(() => {
                    setSelectOptions(dom.cameraSelect, [Object.assign(document.createElement('option'), {
                        value: '0', textContent: 'Error loading cameras', disabled: true
                    })], 'Select a camera...');
                });
        }

        function loadModels() {
            const select = dom.modelSelect;
            setSelectOptions(select, [], 'Loading models...');
            fetch('/get_models?all=1')
                .then(r => r.json())
                .then(models => {
                    if (models && models.length > 0) {
                        const opts = models.map(m => {
                            const o = document.createElement('option');
                            if (typeof m === 'string') {
                                o.value = m;
                                o.textContent = m;
                                return o;
                            }
                            o.value = m.name;
                            o.textContent = m.compatible ? m.name : `${m.name} (incompatible)`;
                            if (!m.compatible) o.disabled = true;
                            return o;
                        });
                        setSelectOptions(select, opts, 'Select a model...');
                        // Prefer first compatible model
                        const firstCompatible = (models || []).findIndex(x => typeof x === 'string' || x.compatible);
                        select.selectedIndex = Math.max(0, firstCompatible);
                    } else {
                        setSelectOptions(select, [Object.assign(document.createElement('option'), {
                            value: '', textContent: 'No models found', disabled: true
                        })], 'Select a model...');
                    }
                })
                .catch(() => {
                    setSelectOptions(select, [Object.assign(document.createElement('option'), {
                        value: '', textContent: 'Error loading models', disabled: true
                    })], 'Select a model...');
                });
        }

        // --- Connection Status ---
        function updateConnectionStatus() {
            fetch('/get_connection_status')
                .then(r => r.json())
                .then(data => {
                    const { source, status } = data;
                    if (source === 'rtsp') {
                        dom.originalConnectionStatus.style.display = 'block';
                        dom.detectionConnectionStatus.style.display = 'block';
                        let text, cls;
                        if (status === 'connected') {
                            text = 'Connected'; cls = 'connection-status status-connected';
                        } else if (status === 'reconnecting') {
                            text = 'Reconnecting...'; cls = 'connection-status status-reconnecting';
                        } else {
                            text = 'Disconnected'; cls = 'connection-status status-disconnected';
                        }
                        dom.originalConnectionStatus.textContent = text;
                        dom.originalConnectionStatus.className = cls;
                        dom.detectionConnectionStatus.textContent = text;
                        dom.detectionConnectionStatus.className = cls;
                    } else {
                        dom.originalConnectionStatus.style.display = 'none';
                        dom.detectionConnectionStatus.style.display = 'none';
                    }
                });
        }

        // --- Event Handlers ---
        function handleSourceChange() {
            const source = dom.sourceSelect.value;
            dom.imageSelectGroup.style.display = source === 'image' ? 'block' : 'none';
            dom.videoSelectGroup.style.display = source === 'video' ? 'block' : 'none';
            dom.cameraSelectGroup.style.display = source === 'camera' ? 'block' : 'none';
            dom.rtspGroup.style.display = source === 'rtsp' ? 'block' : 'none';
        }

        function handleRtspInput() {
            const url = dom.rtspUrl.value;
            showError(dom.rtspError, url && !url.startsWith('rtsp://'));
        }

        function handleApply() {
            const source = dom.sourceSelect.value;
            let asset = '', rtspUrl = '', cameraIndex = 0;
            const modelName = dom.modelSelect.value;
            if (source === 'rtsp') {
                rtspUrl = dom.rtspUrl.value;
                if (!rtspUrl) return alert('Please enter an RTSP URL');
                if (!rtspUrl.startsWith('rtsp://')) {
                    showError(dom.rtspError, true); return;
                }
            }
            if (source === 'image') {
                if (!dom.imageSelect.value) return alert('Please select an image');
                asset = dom.imageSelect.value;
            } else if (source === 'video') {
                if (!dom.videoSelect.value) return alert('Please select a video');
                asset = dom.videoSelect.value;
            } else if (source === 'camera') {
                if (!dom.cameraSelect.value && dom.cameraSelect.value !== 0) return alert('Please select a camera');
                cameraIndex = parseInt(dom.cameraSelect.value);
            }
            // Show loaders, hide errors/feeds
            showLoader(dom.originalLoader, true);
            showLoader(dom.detectionLoader, true);
            showFeed(dom.originalFeed, false);
            showFeed(dom.detectionFeed, false);
            showError(dom.originalError, false);
            showError(dom.detectionError, false);
            fetch('/set_source', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source, asset, rtspUrl, cameraIndex, modelName })
            })
            .then(r => r.json())
            .then(data => {
                if (data.status === 'success') {
                    setTimeout(() => {
                        dom.originalFeed.onerror = () => {
                            showLoader(dom.originalLoader, false);
                            showError(dom.originalError, true);
                        };
                        dom.detectionFeed.onerror = () => {
                            showLoader(dom.detectionLoader, false);
                            showError(dom.detectionError, true);
                        };
                        dom.originalFeed.src = "{{ url_for('video_feed') }}?" + new Date().getTime();
                        dom.detectionFeed.src = "{{ url_for('inference_feed') }}?" + new Date().getTime();
                        setTimeout(() => {
                            showLoader(dom.originalLoader, false);
                            showLoader(dom.detectionLoader, false);
                            showFeed(dom.originalFeed, true);
                            showFeed(dom.detectionFeed, true);
                        }, 500);
                    }, 500);
                }
            })
            .catch(() => {
                showLoader(dom.originalLoader, false);
                showLoader(dom.detectionLoader, false);
                showError(dom.originalError, true);
                showError(dom.detectionError, true);
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            // Load API key from storage
            const savedKey = getApiKeyFromStorage();
            if (savedKey) dom.eiApiKey.value = savedKey;
            dom.eiApiKey.addEventListener('change', function() {
                saveApiKeyToStorage(dom.eiApiKey.value);
                showApiKeySaved();
            });

            // Load deployment API key from storage
            const savedDeployKey = getDeployApiKeyFromStorage();
            if (savedDeployKey) dom.eiDeployApiKey.value = savedDeployKey;
            dom.eiDeployApiKey.addEventListener('change', function() {
                saveDeployApiKeyToStorage(dom.eiDeployApiKey.value);
                showDeployApiKeySaved();
            });

            // Load deploy impulse ID from storage
            const savedImpulseId = getDeployImpulseIdFromStorage();
            if (savedImpulseId && dom.eiDeployImpulseId) dom.eiDeployImpulseId.value = savedImpulseId;
            if (dom.eiDeployImpulseId) {
                dom.eiDeployImpulseId.addEventListener('change', function() {
                    saveDeployImpulseIdToStorage(dom.eiDeployImpulseId.value);
                });
            }

            // Load deploy target + quantization from storage
            const savedDeployTarget = getDeployTargetFromStorage();
            if (savedDeployTarget && dom.eiDeployTarget) {
                dom.eiDeployTarget.value = savedDeployTarget;
            }
            if (dom.eiDeployTarget) {
                dom.eiDeployTarget.addEventListener('change', function() {
                    saveDeployTargetToStorage(dom.eiDeployTarget.value);
                });
            }

            const savedDeployQuant = getDeployQuantFromStorage();
            if (savedDeployQuant && dom.eiDeployQuant) {
                dom.eiDeployQuant.value = savedDeployQuant;
            }
            if (dom.eiDeployQuant) {
                dom.eiDeployQuant.addEventListener('change', function() {
                    saveDeployQuantToStorage(dom.eiDeployQuant.value);
                });
            }

            // Restore upload options
            const savedCategory = getEiCategoryFromStorage();
            if (savedCategory && dom.eiCategory) dom.eiCategory.value = savedCategory;
            const savedLabelMode = getEiLabelModeFromStorage();
            if (savedLabelMode && dom.eiLabelMode) dom.eiLabelMode.value = savedLabelMode;

            // Persist upload options when changed
            if (dom.eiCategory) dom.eiCategory.addEventListener('change', () => saveEiCategoryToStorage(dom.eiCategory.value));
            if (dom.eiLabelMode) dom.eiLabelMode.addEventListener('change', () => saveEiLabelModeToStorage(dom.eiLabelMode.value));
            loadAssets('image', dom.imageSelect);
            loadAssets('video', dom.videoSelect);
            loadCameras();
            loadModels();
            updateConnectionStatus();
            setInterval(updateConnectionStatus, 1000);
        });
        dom.sourceSelect.addEventListener('change', handleSourceChange);
        dom.rtspUrl.addEventListener('input', handleRtspInput);
        dom.applyBtn.addEventListener('click', handleApply);
        dom.eiUploadBtn.addEventListener('click', uploadCurrentOriginalFrame);
        dom.eiDeployDownloadBtn.addEventListener('click', () => deployDownloadOrBuild({forceRebuild: false}));
        dom.eiDeployRebuildBtn.addEventListener('click', () => deployDownloadOrBuild({forceRebuild: true}));

        // --- Stats EventSources ---
        const speedSource = new EventSource("/inference_speed");
        speedSource.onmessage = e => dom.inferenceSpeed.textContent = e.data;
        speedSource.onerror = () => { speedSource.close(); };
        const countSource = new EventSource("/object_counter");
        countSource.onmessage = e => dom.objectCount.textContent = e.data;
        countSource.onerror = () => { countSource.close(); };
    </script>
</body>
</html>
