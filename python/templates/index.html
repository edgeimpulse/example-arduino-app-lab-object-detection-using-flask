<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Edge Impulse: Rubber Ducky Detection</title>
    <style>
        .settings-panel {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
  <div class="container col-xxl-8 px-4 py-5">
    <img class="d-block mx-auto mb-4" src="assets/EI_logo_stacked.png" alt="" width="200">
    <hr>

    <!-- Settings Panel -->
    <div class="settings-panel">
        <h4>Settings</h4>
        <div class="mb-3">
            <label for="sourceSelect" class="form-label">Input Source:</label>
            <select class="form-select" id="sourceSelect">
                <option value="image">Image</option>
                <option value="video">Video</option>
                <option value="rtsp">RTSP Stream</option>
            </select>
        </div>
        <div class="mb-3" id="imageSelectDiv">
            <label for="imageSelect" class="form-label">Select Image:</label>
            <select class="form-select" id="imageSelect"></select>
        </div>
        <div class="mb-3" id="videoSelectDiv" style="display: none;">
            <label for="videoSelect" class="form-label">Select Video:</label>
            <select class="form-select" id="videoSelect"></select>
        </div>
        <div class="mb-3" id="rtspUrlDiv" style="display: none;">
            <label for="rtspUrl" class="form-label">RTSP Stream URL:</label>
            <input type="text" class="form-control" id="rtspUrl" placeholder="rtsp://example.com/stream">
        </div>
        <button id="applySettings" class="btn btn-primary">Apply</button>
    </div>

    <div class="row">
      <div class="col-6 text-center">
        <h2>Original Frames</h2>
        <img src="{{ url_for('video_feed') }}" class="d-block mx-lg-auto img-fluid" alt="High-res Video" width="800" loading="lazy">
      </div>
      <div class="col-6 text-center">
        <h2>Inference Results</h2>
        <img src="{{ url_for('inference_feed') }}" class="img-fluid border rounded-3 mb-4" width="400" alt="Processed Inference Feed" loading="lazy">
        <div class="col-lg-6 mx-auto">
          <p class="">Inference speed: <span id="inference_speed"></span> ms</p>
          <p class="">Objects detected: <span id="object_counter"></span></p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Toggle visibility of settings based on selected source
    document.getElementById('sourceSelect').addEventListener('change', function() {
        const source = this.value;
        document.getElementById('imageSelectDiv').style.display = source === 'image' ? 'block' : 'none';
        document.getElementById('videoSelectDiv').style.display = source === 'video' ? 'block' : 'none';
        document.getElementById('rtspUrlDiv').style.display = source === 'rtsp' ? 'block' : 'none';
    });

    // Load available images and videos
    document.addEventListener('DOMContentLoaded', function() {
        // Load available images
        fetch('/get_assets?type=image')
            .then(response => response.json())
            .then(assets => {
                const imageSelect = document.getElementById('imageSelect');
                assets.forEach(asset => {
                    const option = document.createElement('option');
                    option.value = asset;
                    option.textContent = asset;
                    imageSelect.appendChild(option);
                });
            });

        // Load available videos
        fetch('/get_assets?type=video')
            .then(response => response.json())
            .then(assets => {
                const videoSelect = document.getElementById('videoSelect');
                assets.forEach(asset => {
                    const option = document.createElement('option');
                    option.value = asset;
                    option.textContent = asset;
                    videoSelect.appendChild(option);
                });
            });
    });

    // Apply settings
    document.getElementById('applySettings').addEventListener('click', function() {
        const source = document.getElementById('sourceSelect').value;
        let asset = null;
        let rtspUrl = null;

        if (source === 'image') {
            asset = document.getElementById('imageSelect').value;
        } else if (source === 'video') {
            asset = document.getElementById('videoSelect').value;
        } else if (source === 'rtsp') {
            rtspUrl = document.getElementById('rtspUrl').value;
        }

        fetch('/set_source', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                source: source,
                asset: asset,
                rtspUrl: rtspUrl
            })
        });
    });

    // EventSource for inference speed and object counter
    const sourceInference = new EventSource("/inference_speed");
    sourceInference.onmessage = (event) => {
      document.getElementById("inference_speed").textContent = event.data;
    };

    const sourceObjects = new EventSource("/object_counter");
    sourceObjects.onmessage = (event) => {
      document.getElementById("object_counter").textContent = event.data;
    };
  </script>
</body>
</html>
